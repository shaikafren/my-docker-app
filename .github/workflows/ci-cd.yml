name: CI/CD Pipeline for Docker App

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ðŸ§© Debug step (optional â€” helps confirm secrets are visible)
      - name: Debug secret check
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then echo "âŒ Username missing"; else echo "âœ… Username found"; fi
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then echo "âŒ Token missing"; else echo "âœ… Token found"; fi

      # ðŸ³ Build Docker image
      - name: Build Docker image
        run: docker build -t my-docker-app .

      # ðŸ” Login to DockerHub using your saved GitHub secrets
      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # ðŸ“¤ Push image to DockerHub
      - name: Push image to DockerHub
        run: |
          docker tag my-docker-app ${{ secrets.DOCKERHUB_USERNAME }}/my-docker-app:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/my-docker-app:latest

      # ðŸ’» Deploy to EC2 instance
      - name: Deploy on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "${EC2_SSH_KEY}" > private_key.pem
          chmod 600 private_key.pem

          ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@${EC2_HOST} << 'EOF'
            docker pull ${DOCKERHUB_USERNAME}/my-docker-app:latest
            docker stop my-docker-app || true
            docker rm my-docker-app || true
            docker run -d -p 80:80 --name my-docker-app ${DOCKERHUB_USERNAME}/my-docker-app:latest
          EOF
